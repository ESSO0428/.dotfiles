#!/bin/bash

trap cleanup INT

function cleanup() {
    echo "Cleaning up..."
    pkill "ncat"
    pkill -f "ssh -NR"
    exit 0
}

# 殺死所有當前運行的ncat和ssh -NR進程
pkill "ncat"
pkill -f "ssh -NR"

# 檢查當前正在運行的SSH連接
ssh_connections=$(ps aux | grep "ssh -Y" | grep -v grep)

# 選擇一個起始端口
port=5000

# 為每個SSH連接建立反向隧道和ncat監聽
echo "$ssh_connections" | while read line; do
    # 從SSH命令中提取server_ip
    server_ip=$(echo $line | awk '{print $NF}')

    # 打印並執行命令
    ssh_cmd="ssh -NR $port:localhost:$port $server_ip"
    echo "Running: $ssh_cmd"
    $ssh_cmd &

    ncat_cmd="ncat -l --keep-open $port -e /bin/bash"
    echo "Running: $ncat_cmd"
    $ncat_cmd &

    # 將端口號寫入到遠端的~/.rssh_tunnel文件中
    ssh $server_ip "echo $port > ~/.rssh_tunnel" &

    # 增加端口號以供下一次使用
    port=$((port+1))
done

# 檢查是否提供了'--slient'參數
if [[ "$1" != "--silent" ]]; then
    echo '-----------------------------------------------------'
    echo "Press Ctrl+C to close \"ssh -NR\" and \"nat\" process ..."

    # 保持腳本運行，直到用戶按下Ctrl+C
    while true; do
        sleep 1
    done
fi

